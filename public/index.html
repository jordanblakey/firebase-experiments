<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scorched: Secure, Portable Notes</title>

  <!-- FIREBASE -->
  <script defer src="/__/firebase/5.2.0/firebase-app.js"></script>
  <script defer src="/__/firebase/5.2.0/firebase-firestore.js"></script>
  <script defer src="/__/firebase/5.2.0/firebase-auth.js"></script>
  <script defer src="/__/firebase/5.2.0/firebase-storage.js"></script>
  <script defer src="/__/firebase/init.js"></script>
  <script defer src="settings.js"></script>

  <script>
    app = firebase.app()
    features = ['auth', 'database', 'messaging', 'storage'].filter(
      feature => typeof app[feature] === 'function'
    )
    document.getElementById(
      'load'
    ).innerHTML = `Firebase SDK loaded with ${features.join(', ')}`
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION) // SESSION, LOCAL
    settings = { timestampsInSnapshots: true }
    firebase.firestore.settings(settings)
  </script>

  <!-- STYLE -->
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,600" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300" rel="stylesheet">

  <!-- ICONS -->
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="icon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icon/favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="icon/safari-pinned-tab.svg" color="#c4c4c4">
  <meta name="msapplication-TileColor" content="#c4c4c4">
  <meta name="theme-color" content="#e5e5e5">
</head>

<body>

  <div id="authStatus"></div>

  <div id="pageContent">
    <div id="message">
      <img id="logo" src="./img/logo-scorched.svg">
      <h1>Secure, Portable Notes.</h1>
      <p>Currently in pre-alpha.
        <br> Built with Firebase and React Native.
        <br> For web, Android, and iOS.</p>
      <h4>Builds</h4>
      <ul>
        <li>Web:
          <a href="app">scorched.site/app</a>
        </li>
        <li> Android:
          <a href="https://firebasestorage.googleapis.com/v0/b/native-notes-2b16e.appspot.com/o/scorched-0.0.2.apk?alt=media&token=4c4ec683-a415-4ce5-9746-ede7b42d2532">scorched-0.0.2.apk</a>
        </li>
        <li> iOS:
          <a href="#">Coming soon</a>
        </li>
        <li>Source:
          <a href="https://github.com/jordanblakey/scorched-site">Github</a>
        </li>
      </ul>
    </div>
    <p id="load">Firebase SDK Loading&hellip;</p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥
      // firebase.auth().onAuthStateChanged(user => { });
      // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
      // firebase.messaging().requestPermission().then(() => { });
      // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
      // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

      try {
        let loggedInUser
        getAuthStatus(loggedInUser)
      } catch (e) {
        console.error(e)
        document.getElementById('load').innerHTML =
          'Error loading the Firebase SDK, check the console.'
      }
    })

    function getAuthStatus(loggedInUser) {
      firebase.auth().onAuthStateChanged(function (user) {
        let authStatus = document.querySelector('#authStatus')
        if (user) {
          loggedInUser = user
          renderPage(user)
          authStatus.innerHTML = `<img id="logo-small" src="./img/logo-scorched.svg"><p>Logged in as ${
            loggedInUser.displayName
            } <button onclick="googleLogout()">Log Out</button></p>`
        } else {
          authStatus.innerHTML = `<p>Not logged in <button onclick="googleLogin()">Google Log In</button></p>`
        }
      })
    }

    function googleLogin(loggedInUser) {
      const provider = new firebase.auth.GoogleAuthProvider()
      firebase.auth
        .signInWithPopup(provider)
        .then(result => {
          loggedInUser = result.user
          renderPage(result)
        })
        .catch(err => {
          authStatus.innerHTML = err
        })
    }

    function googleLogout() {
      firebase.auth
        .signOut()
        .then(function () {
          location.reload()
        })
        .catch(err => {
          authStatus.innerHTML = err
        })
    }

    function renderPage(res) {
      myNote = firebase.firestore.collection('notes').doc('kqrOIlpWlbPrk6ZQNrmi')
      myNote.get().then(doc => {
        const data = doc.data()

        let pageContent = document.querySelector('#pageContent')
        pageContent.innerHTML = `
          <div class="note">
              <h1 id="title">arst${data.title}</h1>
              <p id="body">${data.body}</p>
              <code id="createdAt">${data.createdAt}</code>
            </div>
          `
        fileUploader(pageContent)
        scratchPad(pageContent)
        formUpdater(pageContent)
      })
    }
    // //////////////////////////////////////////////////////////////////////////////
    // NOTE UPDATE FORM
    // //////////////////////////////////////////////////////////////////////////////

    function formUpdater(pageContent) {
      // CREATE FORM DOM
      pageContent.innerHTML += `
        <div id="updateForm">
          <input id="updateTitle" type="text" placeholder="Update note title">
          <input id="updateBody" type="text" placeholder="Update note body">
          <button id="updateCreatedAt" type="text">Update timestamp</button>
        </div>
      `

      const myNote = firebase.firestore
        .collection('notes')
        .doc('kqrOIlpWlbPrk6ZQNrmi')

      // EVENT LISTENERS FOR FORM
      const titleInput = document.getElementById('updateTitle')
      titleInput.onkeyup = updateTitle
      const bodyInput = document.getElementById('updateBody')
      bodyInput.onkeyup = updateBody
      const createdAtInput = document.getElementById('updateCreatedAt')
      createdAtInput.onclick = updateCreatedAt

      myNote.onSnapshot(doc => {
        const data = doc.data()
        document.querySelector('#title').innerHTML = data.title
        document.querySelector('#body').innerHTML = data.body
        document.querySelector('#createdAt').innerHTML = data.createdAt
      })

      function updateTitle(e) {
        myNote.update({ title: e.target.value })
      }
      function updateBody(e) {
        myNote.update({ body: e.target.value })
      }
      function updateCreatedAt(e) {
        myNote.update({ createdAt: Date(Date.now()).toString() })
      }
    }

    // //////////////////////////////////////////////////////////////////////////////
    // SCRATCHPAD
    // //////////////////////////////////////////////////////////////////////////////

    function scratchPad(pageContent) {
      pageContent.innerHTML += `
        <div class="scratchpad" id="sp1">
          <h3>Scratchpad</h3>
        </div>
      `

      const productsRef = firebase.firestore.collection('products')

      let query
      // query = productsRef.where('price', '>', 10)
      // query = productsRef.orderBy('price', 'desc')
      query = productsRef.orderBy('price', 'desc').limit(2)
      query.get().then(products => {
        products.forEach(doc => {
          data = doc.data()
          document.querySelector('#sp1').innerHTML += `${data.name} at $${
            data.price
            }<br>`
        })
      })
    }

    // //////////////////////////////////////////////////////////////////////////////
    // FILE UPLOADER
    // //////////////////////////////////////////////////////////////////////////////

    function fileUploader(pageContent) {
      pageContent.innerHTML += `
        <div class="scratchpad" id="sp2">
          <h3>FB Storage Upload</h3>
          <input type="file" onchange="${uploadFile(this.files)}">
          <hr>
          <img id="imgUpload" src="" width="100%" />
        </div>
      `
    }

    function uploadFile(files) {
      const file = files.item(0)
      const ref = firebase
        .storage()
        .ref()
        .child(file.name)
      const img = document.querySelector('#imgUpload')
      ref.put(file).then(ref.getDownloadURL().then(url => (img.src = url)))
    }
  </script>
</body>

</html>